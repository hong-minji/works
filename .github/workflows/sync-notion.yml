name: Sync Notion and Auto Deploy

on:
  # 10ë¶„ë§ˆë‹¤ ì‹¤í–‰ (UTC ê¸°ì¤€)
  schedule:
    - cron: '*/10 * * * *'

  # main ë¸Œëžœì¹˜ì— pushë  ë•Œë„ ì‹¤í–‰
  push:
    branches: [ main ]

  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  sync-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Configure Git
      run: |
        git config --global user.name 'GitHub Actions Bot'
        git config --global user.email 'actions@github.com'

    - name: Fetch current Notion data
      env:
        NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
        NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
      run: |
        echo "ðŸ”„ Fetching latest Notion data..."

        # í˜„ìž¬ ë°ì´í„° ë°±ì—… (ë¹„êµìš©)
        if [ -d "public" ]; then
          cp -r public public_backup
        fi

        # Gatsby ë¹Œë“œ (Notion ë°ì´í„° fetch í¬í•¨)
        npm run build

        echo "âœ… Notion data fetched and site built"

    - name: Check for changes
      id: check_changes
      run: |
        # public ë””ë ‰í„°ë¦¬ì˜ ë³€ê²½ì‚¬í•­ í™•ì¸
        if [ -d "public_backup" ]; then
          # ë°±ì—…ê³¼ í˜„ìž¬ ë¹Œë“œ ê²°ê³¼ ë¹„êµ
          if diff -r public_backup public > /dev/null 2>&1; then
            echo "ðŸ“ No changes detected in Notion content"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "âœ¨ Changes detected in Notion content"
            echo "has_changes=true" >> $GITHUB_OUTPUT

            # ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ì¶œë ¥
            echo "Changed files:"
            diff -qr public_backup public | head -20 || true
          fi
          rm -rf public_backup
        else
          # ì²« ë¹Œë“œì¸ ê²½ìš°
          echo "ðŸŽ‰ First build - deploying all content"
          echo "has_changes=true" >> $GITHUB_OUTPUT
        fi

    - name: Deploy to GitHub Pages
      if: steps.check_changes.outputs.has_changes == 'true'
      uses: JamesIves/github-pages-deploy-action@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        branch: gh-pages
        folder: public
        clean: true
        commit-message: |
          ðŸ”„ Auto-sync from Notion

          Updated at: ${{ github.event.repository.updated_at }}
          Triggered by: ${{ github.event_name }}

    - name: Create summary
      run: |
        echo "## ðŸ¤– Notion Sync Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]; then
          echo "âœ… **Status**: Changes detected and deployed" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ **Site**: https://hong-minji.github.io/works" >> $GITHUB_STEP_SUMMARY
        else
          echo "â„¹ï¸ **Status**: No changes detected" >> $GITHUB_STEP_SUMMARY
          echo "â° **Next check**: In 10 minutes" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“… **Time**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”§ **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY